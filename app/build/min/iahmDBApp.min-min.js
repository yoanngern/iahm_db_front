/*! iahmDBApp 2015-07-20 */
"use strict";angular.module("iahmDBApp.connect",["ngRoute","angular-md5"]).config(["$routeProvider",function(a){a.when("/login",{templateUrl:"views/login.html",controller:"connectCtrl"})}]).controller("connectCtrl",["$scope","$http","$location","md5",function(a,b,c,d){a.$on("oauth:login",function(b,c){console.log("yo"),a.accessToken=c.access_token}),a.$on("oauth:logout",function(b){a.accessToken=null}),a.connect={state:d.createHash("test")},a.$on("oauth:login",function(a,b){console.log("Authorized third party app with token",b.access_token)}),a.$on("oauth:logout",function(a){console.log("The user has signed out")}),a.$on("oauth:loggedOut",function(a){console.log("The user is not signed in")}),a.$on("oauth:denied",function(a){console.log("The user did not authorize the third party app")}),a.$on("oauth:expired",function(a){console.log("The access token is expired. Please refresh.")}),a.$on("oauth:profile",function(a){console.log("User profile data retrieved: ",a)})}]),angular.module("iahmDBApp.editView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/doc/:doc_type?/:id?/edit",{templateUrl:"views/edit.html",controller:"editCtrl"})}]).controller("editCtrl",["$scope","$http","$routeParams","$location",function(a,b,c,d){a.doc_type=c.doc_type,console.log(a.doc_type);var e="";a.doc={id:c.id},"contact"==a.doc_type&&(e="contacts",a.doc={id:c.id,contact:{firstname:"Yoann",lastname:"nom",title:"title",gender:"man",dateOfBirth:"1993-05-06",phones:[{number:"376418972365987",type:"mobile"}],emails:[{value:"yoann@yoanngern.ch",type:"private"}],languages:["fr","en"],comment_txt:"test blabla",type:"father",memberOfs:[],leaderOfs:[],events:[]}}),"event"==a.doc_type&&(e="events",a.doc={id:c.id,event:{title:"Mon super event2",start:"2011-06-05 12:15:00",end:"2012-06-05 12:15:00",parent:2,persons:[2],groups:[{group:{title:"test"}}]}});var f={method:"GET",dataType:"json",headers:{"Content-Type":"application/json"}};b.get("http://iahmdb.local/app_dev.php/api/"+e+"/"+a.doc.id+"?access_token="+a.oauth.access_token,f).success(function(b,c,d,e){a.doc.event.title=b.title,a.doc.event.end=b.end,a.doc.event.start=b.start,a.doc.event.groups=b.groups,a.doc.event.persons=b.participants,a.message=""}).error(function(a,b,c,d){}),console.log("edit: "+a.doc.id),a.saveDoc=function(){var c={event:a.doc.event};c.event.start="2011-06-05 12:15:00",c.event.end="2012-06-05 12:15:00",c.event.parent=2,c.event.persons=[],c.event.groups=[];var f={dataType:"json",headers:{"Content-Type":"application/json"}};b.put("http://iahmdb.local/app_dev.php/api/"+e+"/"+a.doc.id+"?access_token="+a.oauth.access_token,JSON.stringify(c),f).success(function(b,c,e,f){d.path("/doc/"+a.doc_type+"/"+a.doc.id)}).error(function(a,b,c,d){console.log(a)})}}]),angular.module("iahmDBApp",["ngRoute","ngStorage","LocalStorageModule","xeditable","iahmDBApp.secure","iahmDBApp.oauth_callback","iahmDBApp.searchView","iahmDBApp.showView","iahmDBApp.editView","iahmDBApp.view2","iahmDBApp.version"]).config(["$routeProvider","$locationProvider","localStorageServiceProvider",function(a,b,c){a.otherwise({redirectTo:"/search"}),c.setPrefix("iahm_db_front").setStorageType("sessionStorage")}]).controller("appCtrl",["$scope","$timeout","$location","$http","localStorageService","$filter",function(a,b,c,d,e,f){if(a.isLogged=!1,a.oauth={client_id:"19_64bxhmfwc8g8c4s0w8w04g4s004o00o44wswg8csw8cgc4cksk",redirect_uri:"http://iahmdb-front.local/oauth_callback.php",response_type:"token",expires_in:null,access_token:"",refresh_token:"",code:"",scope:"",token_type:""},a.refreshToken=function(){d.get("http://iahmdb-front.local/refresh_token.php?refresh_token="+a.oauth.refresh_token).success(function(b,c,d,e){a.oauth.access_token=b.access_token,a.oauth.expires_in=b.expires_in,a.oauth.refresh_token=b.refresh_token,a.oauth.scope=b.scope,a.oauth.token_type=b.token_type,a.isLogged=!0}).error(function(b,c,d,e){a.isLogged=!1})},null!=JSON.parse(window.localStorage.getItem("iahm_api"))){a.oauth.access_token=JSON.parse(window.localStorage.getItem("iahm_api")).oauth.access_token,a.oauth.refresh_token=JSON.parse(window.localStorage.getItem("iahm_api")).oauth.refresh_token,a.oauth.code=JSON.parse(window.localStorage.getItem("iahm_api")).oauth.code,window.localStorage.removeItem("iahm_api");var g={access_token:a.oauth.access_token,refresh_token:a.oauth.refresh_token};e.set("oauth",g)}e.get("oauth")&&(a.oauth.access_token=e.get("oauth").access_token,a.oauth.refresh_token=e.get("oauth").refresh_token,a.refreshToken()),a.$watch("oauth",function(){var b={access_token:a.oauth.access_token,refresh_token:a.oauth.refresh_token};e.set("oauth",b)},!0),a.login=function(){window.location.href="http://iahmdb.local/app_dev.php/oauth/v2/auth?client_id="+a.oauth.client_id+"&response_type=code&redirect_uri="+a.oauth.redirect_uri},a.logout=function(){a.isLogged=!1},a.message="",a.searchValue="",a.searchConstructor={q:"*:*",entity:""},a.searchAll=function(){a.searchConstructor.q=a.searchValue,a.isLogged&&c.path("search")},a.calculateAge=function(a){var b=f("date")(a,"yyyy"),c=f("date")(a,"MM"),d=f("date")(a,"dd"),e=Date.now()-new Date(b,c,d),g=new Date(e);return Math.abs(g.getUTCFullYear()-1970)},a.restContact={},a.restEntity={},a.restDonation={},a.restGroup={},a.restLocation={},a.restEvent={},a.restContact.getContact=function(b){a.getRest("contacts/"+b,"ContactReceived")},a.restContact.getDonations=function(b){a.getRest("contacts/"+b+"/donations","DonationsReceived")},a.restContact.getEvents=function(b){a.getRest("contacts/"+b+"/events","EventsReceived")},a.restContact.getGroups=function(b){a.getRest("contacts/"+b+"/groups","GroupsReceived")},a.restContact.putContact=function(b){if(null==b)return!1;var c={firstname:b.firstname,lastname:b.lastname,title:b.title,gender:b.gender,dateOfBirth:b.date_of_birth,languages:[],events:b.events,phones:b.phones,emails:[],memberOfs:[],leaderOfs:[],comment_txt:b.comment,type:b.type};a.putRest("contacts/"+b.id,c,"ContactUpdated")},a.restDonation.putDonation=function(b){if(null==b)return!1;console.log(b);var c={donation:{date:"2011-06-05 12:15:00",amount:b.amount,currency:b.currency,type:b.type,person:b.contact_id,comment_txt:b.comment.text,entity:null}};a.putRest("donations/"+b.id,c,"DonationUpdated")},a.getRest=function(b,c){var e={method:"GET",headers:{"Content-Type":"application/json"}};d.get("http://iahmdb.local/app_dev.php/api/"+b+"?access_token="+a.oauth.access_token,e).success(function(b,d,e,f){a[c]=b}).error(function(a,b,c,d){return!1})},a.putRest=function(b,c,e){var f={dataType:"json",headers:{"Content-Type":"application/json"}};d.put("http://iahmdb.local/app_dev.php/api/"+b+"?access_token="+a.oauth.access_token,JSON.stringify(c),f).success(function(b,c,d,f){a[e]=b}).error(function(a,b,c,d){return!1})}}]),angular.module("iahmDBApp.login",["ngRoute"]).config(["$routeProvider",function(a){a.when("/login",{templateUrl:"views/login.html",controller:"loginCtrl"})}]).controller("loginCtrl",["$scope","$http",function(a,b){}]),angular.module("iahmDBApp.oauth_callback",["ngRoute"]).config(["$routeProvider",function(a){a.when("/oauth_callback",{templateUrl:"views/oauth_callback.html",controller:"oauthCtrl"})}]).controller("oauthCtrl",["$scope","$http",function(a,b){console.log("oauth ctrl")}]),angular.module("iahmDBApp.searchView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/search",{templateUrl:"views/search.html",controller:"searchCtrl"})}]).controller("searchCtrl",["$scope","$http","$location",function(a,b,c){a.results=[],a.searchRequest="",a.filterSearch=function(b){console.log(b),a.searchConstructor.entity=b,"all"==b&&(a.searchConstructor.entity=""),console.log(a.searchConstructor)},a.showView=function(b,d){a.message="loading...",c.path("doc/"+b+"/"+d)},a.$watch("searchConstructor",function(){""!=a.searchConstructor.q?a.searchRequest=a.searchConstructor.q:a.searchRequest="*:*",a.searchConstructor.entity&&(a.searchRequest+=" AND doc_type:"+a.searchConstructor.entity)},!0),a.$watch("searchRequest",function(){var c={method:"GET",headers:{"Content-Type":"application/javascript"},params:{q:a.searchRequest,access_token:a.oauth.access_token}};a.message="loading...",b.get("http://iahmdb.local/app_dev.php/api/search",c).success(function(b,c,d,e){a.results=b,a.message=""}).error(function(b,c,d,e){"invalid_grant"==b.error&&a.refreshToken()})},!0)}]),angular.module("iahmDBApp.secure",["ngRoute"]).config(["$routeProvider",function(a){a.when("/secure",{templateUrl:"views/secure.html",controller:"secureCtrl"})}]).controller("secureCtrl",["$scope","$http",function(a,b){console.log("Secure ctrl")}]),angular.module("iahmDBApp.showView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/doc/:doc_type?/:id?",{templateUrl:"views/show.html",controller:"showCtrl"})}]).controller("showCtrl",["$scope","$http","$routeParams","$location",function(a,b,c,d){a.doc_type=c.doc_type;var e="";("undefined"==typeof c.doc_type||"undefined"==typeof c.id)&&d.path("/search"),"contact"==a.doc_type&&(e="contacts"),"event"==a.doc_type&&(e="events"),a.doc={id:c.id},a.getDoc=function(){"contact"==a.doc_type&&(a.restContact.getContact(a.doc.id),a.restContact.getDonations(a.doc.id),a.restContact.getEvents(a.doc.id),a.restContact.getGroups(a.doc.id))},a.getDoc(),a.tabs=[{title:"Informations générales",url:"infos.tpl.html"},{title:"Evénements",url:"events.tpl.html"},{title:"Groupes",url:"groups.tpl.html"},{title:"Adresses",url:"locations.tpl.html"},{title:"Dons",url:"donations.tpl.html"},{title:"Entités",url:"entities.tpl.html"}],a.currentTab="infos.tpl.html",a.onClickTab=function(b){a.currentTab=b.url},a.isActiveTab=function(b){return b==a.currentTab},a.$watch("doc.donations",function(){$(a.doc.donations).each(function(b,c){c.contact_id=a.doc.contact.id,a.restDonation.putDonation(c)})},!0),a.$watch("ContactReceived",function(){a.doc.contact=a.ContactReceived,a.contact=a.doc.contact},!0),a.$watch("DonationsReceived",function(){return null==a.DonationsReceived?!1:(a.doc.donations=a.DonationsReceived.donations,void(a.donations=a.doc.donations))},!0),a.$watch("EventsReceived",function(){return null==a.EventsReceived?!1:(a.doc.events=a.EventsReceived.events,void(a.events=a.doc.events))},!0),a.$watch("GroupsReceived",function(){return null==a.GroupsReceived?!1:(a.doc.groups=[],$(a.GroupsReceived.leaderOfGroups).each(function(b,c){c.role="leader",a.doc.groups.push(c)}),$(a.GroupsReceived.memberOfGroups).each(function(b,c){c.role="member",a.doc.groups.push(c)}),void(a.groups=a.doc.groups))},!0),a.$watch("ContactUpdated",function(){console.log("ContactUpdated"),a.restContact.getContact(a.doc.id)},!0)}]),angular.module("iahmDBApp.view2",["ngRoute"]).config(["$routeProvider",function(a){a.when("/view2",{templateUrl:"view2/view2.html",controller:"View2Ctrl"})}]).controller("View2Ctrl",[function(){}]);

